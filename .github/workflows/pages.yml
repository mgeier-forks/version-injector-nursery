name: Build docs for branches/tags
on:
  push:
  # TODO: specify which branches?
  # TODO: also run on tags
  workflow_dispatch:
permissions:
  contents: read
  pages: write
  id-token: write
env:
  # NB: We want to use "latest" for the main branch.
  VERSION: ${{ github.ref_name == github.event.repository.default_branch && 'latest' || github.ref_name }}
jobs:
  build-and-upload-pages:
    runs-on: ubuntu-latest
    steps:
      - name: Check out pages storage repository
        uses: actions/checkout@v4
        with:
          repository: mgeier/version-injector-nursery-pages
          token: ${{ secrets.PERSONAL_TOKEN }}
      - name: Check out pages storage repository
        uses: actions/checkout@v4
        with:
          path: version-injector
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3
      - name: Remove target directory
        run: |
          rm -rf pages/$VERSION
      - name: Install Sphinx et al.
        run: |
          python -m pip install sphinx insipid-sphinx-theme
      - name: Build with Sphinx
        run: |
          python -m sphinx version-injector/doc pages/$VERSION --doctree-dir $RUNNER_TEMP --fresh-env --write-all
          # We don't need this:
          rm pages/$VERSION/.buildinfo
      - name: Install version_injector
        run: |
          python -m pip install git+https://github.com/mgeier/version-injector-nursery.git
      - name: Inject versions
        # TODO: set to "versions" for tags
        run: |
          python -m version_injector $VERSION variants
      - name: Set Git user/email
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
      - name: Commit modified files
        run: |
          # This changes when $VERSION is created for the first time:
          git add version-injector.toml
          git diff --cached --quiet || git commit -m "Changed configuration file for '$VERSION'"
          git add pages/$VERSION
          git diff --cached --quiet || git commit -m "New/updated files for '$VERSION'"
          git add pages
          git diff --cached --quiet || git commit -m "Modified files after '$VERSION' changes"
      - name: Push commits
        # The "concurrency" setting doesn't work for us, see
        # https://github.com/orgs/community/discussions/5435
        # https://github.com/orgs/community/discussions/12835
        # https://github.com/orgs/community/discussions/41518
        # https://github.com/orgs/community/discussions/63136
        # The best thing we can do for now, is to give a helpful error message:
        run: |
          if ! git push
          then
            echo
            echo "On second thought ... maybe you can ignore the above error ..."
            echo
            echo "Did another job run in parallel?"
            echo "If yes, please try re-running this job!"
            echo
            false
          fi
      # Don't forget to activate "pages" in your project settings!
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'pages'
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
